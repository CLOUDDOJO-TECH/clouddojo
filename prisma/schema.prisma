generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

model User {
  userId                 String               @id @default(uuid())
  email                  String               @unique
  firstName              String               @unique
  lastName               String
  role                   userRole?            @default(BASIC)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  hasCompletedOnboarding Boolean              @default(false)
  aiAnalysisReports      AIAnalysisReport[]
  Subscriptions          LsUserSubscription[]
  projectProgresses      ProjectProgress[]
  quizAttempts           QuizAttempt[]
  onboarding             UserOnboarding?
  progress               UserProgress[]
  ProjectDraft           ProjectDraft[]

  // Gamification relations
  streak               UserStreak?
  dailyActivities      DailyActivity[]
  xp                   UserXP?
  xpTransactions       XPTransaction[]
  badges               UserBadge[]
  leaderboardEntries   LeaderboardEntry[]
  gamificationSettings UserGamificationSettings?

  // AI Analysis relations
  quizAnalyses      QuizAnalysis[]
  dashboardAnalysis DashboardAnalysis?
  topicMasteries    TopicMastery[]
}

model UserOnboarding {
  id             String    @id @default(uuid())
  userId         String    @unique
  experience     String
  platforms      String[]
  certifications String[]
  role           String    @default("OTHER")
  focusArea      String[]
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Quiz {
  id           String           @id @default(uuid())
  title        String
  description  String?
  providers    String[]         @default([])
  isPublic     Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  categoryId   String?
  duration     Int?
  free         Boolean?
  level        DifficultyLevel? @default(BEGINER)
  thumbnail    String?
  isNew        Boolean          @default(true)
  questions    Question[]
  category     Category?        @relation(fields: [categoryId], references: [id])
  attempts     QuizAttempt[]
  userProgress UserProgress[]
}

model Question {
  id              String            @id @default(uuid())
  quizId          String
  isMultiSelect   Boolean           @default(false)
  correctAnswer   String[]
  explanation     String?
  createdAt       DateTime          @default(now())
  categoryId      String?
  difficultyLevel String?
  awsService      String?
  content         String
  category        Category?         @relation(fields: [categoryId], references: [id])
  quiz            Quiz              @relation(fields: [quizId], references: [id], onDelete: Cascade)
  attempts        QuestionAttempt[]
  options         QuestionOption[]
}

model Flashcard {
  id         String    @id @default(uuid())
  topic      String
  question   String
  answer     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
}

model UserProgress {
  id          String    @id @default(uuid())
  userId      String
  quizId      String
  score       Int
  completedAt DateTime?
  timeTaken   Int?
  attempts    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model LsSubscriptionPlan {
  id                 String               @id @default(cuid())
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  productId          Int
  productName        String
  name               String
  description        String?
  features           String[]
  individual         Boolean              @default(false)
  team               Boolean              @default(false)
  variantId          Int                  @unique
  variantType        VariantType?         @default(MONTHS)
  price              String
  isUsageBased       Boolean              @default(false)
  interval           String?
  intervalCount      Int?
  trialInterval      String?
  trialIntervalCount Int?
  Subscriptions      LsUserSubscription[]
}

model LsUserSubscription {
  id                     String             @id @default(cuid())
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  lemonSqueezyId         String             @unique
  userId                 String
  planId                 String
  name                   String?
  email                  String?
  orderId                Int
  subscriptionItemId     String
  status                 String
  statusFormatted        String
  renewsAt               String
  endsAt                 String?
  trialEndsAt            String?
  price                  String
  isPaused               Boolean            @default(false)
  isUsageBased           Boolean
  billingPortalUrl       String?
  updatePaymentMethodUrl String?
  subscriptionPlan       LsSubscriptionPlan @relation(fields: [planId], references: [id])
  user                   User               @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model LsWebhookEvent {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  eventName       String
  processed       Boolean  @default(false)
  body            Json
  processingError String?
}

model Category {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  flashcards  Flashcard[]
  questions   Question[]
  quizzes     Quiz[]
  quizAttempt QuizAttempt[]
}

model QuizAttempt {
  id              String            @id @default(uuid())
  userId          String
  quizId          String
  totalScore      Int
  percentageScore Float
  timeSpentSecs   Int
  startedAt       DateTime          @default(now())
  completedAt     DateTime?
  categoryId      String?
  questions       QuestionAttempt[]
  category        Category?         @relation(fields: [categoryId], references: [id])
  quiz            Quiz              @relation(fields: [quizId], references: [id])
  user            User              @relation(fields: [userId], references: [userId])
  quizAnalysis    QuizAnalysis? // New relation

  @@index([userId])
  @@index([quizId])
  @@index([categoryId])
}

model QuestionAttempt {
  id              String      @id @default(uuid())
  quizAttemptId   String
  questionId      String
  userAnswer      String
  isCorrect       Boolean
  timeSpentSecs   Int
  categoryId      String?
  difficultyLevel String
  awsService      String?
  question        Question    @relation(fields: [questionId], references: [id])
  quizAttempt     QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)

  @@index([quizAttemptId])
  @@index([questionId])
  @@index([categoryId])
}

model QuestionOption {
  id         String   @id @default(uuid())
  questionId String
  content    String
  isCorrect  Boolean
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model AIAnalysisReport {
  id              String   @id @default(uuid())
  userId          String
  reportData      Json
  generatedAt     DateTime @default(now())
  expiresAt       DateTime
  lastRequestedAt DateTime @default(now())
  latest          Boolean  @default(true)
  user            User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, latest], name: "userId_latest")
  @@index([userId])
}

// New per-quiz analysis model
model QuizAnalysis {
  id            String   @id @default(uuid())
  quizAttemptId String   @unique
  userId        String
  status        String   @default("pending") // pending, processing, completed, failed
  generatedAt   DateTime @default(now())

  // Basic metrics (FREE tier)
  categoryScores  Json? // { "Storage": 85, "Compute": 70 }
  timeEfficiency  String? // "fast", "average", "slow"
  difficultyTrend String? // "improving", "stable", "declining"

  // Premium metrics
  strengths       Json? // ["Strong in S3 buckets", "Great with Lambda"]
  weaknesses      Json? // ["VPC concepts need work"]
  recommendations Json? // ["Practice VPC labs", "Review security groups"]
  topicMastery    Json? // { "S3": 90, "EC2": 75, "VPC": 45 }
  insights        String? // AI-generated paragraph

  // Metadata
  quizScore        Float?
  processingTimeMs Int?
  error            String?

  quizAttempt QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, generatedAt])
  @@index([status])
}

// Aggregated dashboard analysis
model DashboardAnalysis {
  id            String   @id @default(uuid())
  userId        String   @unique
  lastUpdatedAt DateTime @default(now())
  status        String   @default("pending")

  // Free tier metrics (computed from quiz analyses)
  overallScore       Float?
  totalQuizzesTaken  Int?
  averageTimePerQuiz Int? // seconds
  categoryBreakdown  Json? // Average scores per category
  recentTrend        String? // "improving", "stable", "declining"
  consistencyScore   Int? // 0-100

  // Premium tier metrics
  certificationReadiness Float?
  topStrengths           Json? // Top 5 strengths across all quizzes
  topWeaknesses          Json? // Top 5 weaknesses
  trendingUp             Json? // Categories showing improvement
  trendingDown           Json? // Categories declining
  studyPlan              Json? // AI-generated personalized plan
  estimatedReadyDate     DateTime?
  percentileRank         Float? // Compared to other users
  learningVelocity       String? // "accelerating", "improving", "stable", "declining"

  // Metadata
  lastQuizAnalyzed String? // quizAttemptId
  nextUpdateAt     DateTime?

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([lastUpdatedAt])
}

// Track individual topic mastery over time
model TopicMastery {
  id                String   @id @default(uuid())
  userId            String
  topic             String // "S3", "EC2", "VPC", etc.
  masteryScore      Float // 0-100
  questionsAnswered Int
  lastPracticed     DateTime @default(now())
  trend             String // "improving", "stable", "declining", "new"

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, topic])
  @@index([userId, masteryScore])
}

model ProcessedCronJobUser {
  jobId       String   @id
  userId      String
  processedAt DateTime @default(now())

  @@unique([jobId, userId])
  @@index([processedAt])
}

model Project {
  id                         String                      @id @default(uuid())
  title                      String
  description                String
  difficulty                 DifficultyLevel             @default(BEGINER)
  estimatedTime              Int
  estimatedCost              Int                         @default(0)
  thumbnailUrl               String?
  videoUrl                   String?
  prerequisites              String[]
  learningObjectives         String[]
  keyTechnologies            String[]
  isPremium                  Boolean                     @default(false)
  isPublished                Boolean                     @default(false)
  projectType                ProjectType                 @default(TUTORIAL)
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  projectCategoryAssignments ProjectCategoryAssignment[]
  userProgresses             ProjectProgress[]
  steps                      ProjectStep[]

  @@index([difficulty])
  @@index([isPremium])
  @@index([isPublished])
}

model ProjectCategory {
  id          String                      @id @default(uuid())
  name        String                      @unique
  slug        String                      @unique
  description String?
  imageUrl    String?
  sortOrder   Int                         @default(0)
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  projects    ProjectCategoryAssignment[]

  @@index([slug])
}

model ProjectCategoryAssignment {
  id                String          @id @default(uuid())
  projectId         String
  projectCategoryId String
  assignedAt        DateTime        @default(now())
  project           Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectCategory   ProjectCategory @relation(fields: [projectCategoryId], references: [id], onDelete: Cascade)

  @@unique([projectId, projectCategoryId])
  @@index([projectId])
  @@index([projectCategoryId])
}

model ProjectStep {
  id                 String                @id @default(uuid())
  projectId          String
  stepNumber         Int
  title              String
  description        String?
  instructions       String
  expectedOutput     String?
  validationCriteria String[]
  mediaUrls          String[]
  estimatedTime      Int
  stepType           ProjectStepType       @default(INSTRUCTION)
  isOptional         Boolean               @default(false)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  project            Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  responses          ProjectStepResponse[]

  @@unique([projectId, stepNumber])
  @@index([projectId])
}

model ProjectProgress {
  id                     String                @id @default(uuid())
  userId                 String
  projectId              String
  currentStep            Int                   @default(1)
  completedSteps         Int[]
  startedAt              DateTime              @default(now())
  completedAt            DateTime?
  guidanceMode           GuidanceMode          @default(SOME_GUIDANCE)
  generatedDocumentation String?
  certificateUrl         String?
  status                 ProjectStatus         @default(IN_PROGRESS)
  timeSpent              Int                   @default(0)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  achievements           ProjectAchievement[]
  project                Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                   User                  @relation(fields: [userId], references: [userId], onDelete: Cascade)
  stepResponses          ProjectStepResponse[]

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@index([status])
}

model ProjectStepResponse {
  id               String          @id @default(uuid())
  progressId       String
  stepId           String
  response         String
  completedAt      DateTime        @default(now())
  timeSpent        Int             @default(0)
  hintsUsed        Int             @default(0)
  validationPassed Boolean         @default(false)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  progress         ProjectProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  step             ProjectStep     @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([progressId, stepId])
  @@index([progressId])
  @@index([stepId])
}

model ProjectAchievement {
  id          String          @id @default(uuid())
  progressId  String
  type        AchievementType
  title       String
  description String
  iconUrl     String?
  earnedAt    DateTime        @default(now())
  progress    ProjectProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId])
  @@index([type])
}

model ProjectDraft {
  id          String   @id @default(uuid())
  userId      String
  title       String?
  currentStep Int      @default(1)
  draftData   Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([updatedAt])
}

// ============================================
// GAMIFICATION MODELS
// ============================================

model UserStreak {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActivityAt DateTime @default(now())
  streakFreezes  Int      @default(0) // Available freezes
  streakData     Json     @default("{}") // Daily activity timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
}

model DailyActivity {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  date              DateTime @db.Date
  questionsAnswered Int      @default(0)
  quizzesTaken      Int      @default(0)
  flashcardsStudied Int      @default(0)
  minutesSpent      Int      @default(0)
  xpEarned          Int      @default(0)
  createdAt         DateTime @default(now())

  @@unique([userId, date])
  @@index([userId, date])
}

model UserXP {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  totalXP       Int      @default(0)
  currentLevel  Int      @default(1)
  xpToNextLevel Int      @default(100)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

model XPTransaction {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  amount      Int
  source      String // "quiz_completion", "streak_milestone", etc.
  description String
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
}

model Badge {
  id          String      @id @default(uuid())
  name        String      @unique
  description String
  icon        String // Emoji or icon identifier
  category    String // "streak", "quiz", "learning", "social", "special"
  tier        String // "bronze", "silver", "gold", "platinum"
  requirement Json // Conditions to unlock
  xpReward    Int         @default(0)
  createdAt   DateTime    @default(now())
  userBadges  UserBadge[]

  @@index([category])
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  user     User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  badgeId  String
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt DateTime @default(now())
  progress Int? // For progressive badges

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

model LeaderboardEntry {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  type      String // "global_xp", "weekly_xp", "streak", "aws", etc.
  score     Int
  rank      Int
  period    String // "all_time", "2025-01", "2025-W04"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type, period])
  @@index([type, period, score])
}

model UserGamificationSettings {
  id                       String   @id @default(uuid())
  userId                   String   @unique
  user                     User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  dailyXPGoal              Int      @default(100)
  showOnLeaderboard        Boolean  @default(true)
  streakReminders          Boolean  @default(true)
  achievementNotifications Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@index([userId])
}

enum SubscriptionTier {
  FREE
  PRO
  PREMIUM
}

enum userRole {
  BASIC
  PRO
  PREMIUM
  ADMIN
  SUPERADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PAST_DUE
  PENDING
}

enum DifficultyLevel {
  BEGINER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum VariantType {
  DAYS
  MONTHS
  YEARS
}

enum PlanType {
  PRO_MONTHLY
  PRO_YEARLY
  PREMIUM_MONTHLY
  PREMIUM_YEARLY
}

enum ProjectType {
  TUTORIAL
  CHALLENGE
  ASSESSMENT
  CAPSTONE
}

enum ProjectStepType {
  INSTRUCTION
  QUIZ
  VALIDATION
  REFLECTION
  CHECKPOINT
}

enum GuidanceMode {
  INDEPENDENT
  SOME_GUIDANCE
  STEP_BY_STEP
}

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum AchievementType {
  FIRST_PROJECT
  SPEED_COMPLETION
  PERFECT_SCORE
  DOCUMENTATION_MASTER
  STREAK
  CATEGORY_EXPERT
}

// Demo lead capture for email marketing
model DemoLead {
  id             String   @id @default(uuid())
  email          String   @unique
  score          Int
  totalQuestions Int
  percentage     Int
  provider       String?
  createdAt      DateTime @default(now())
  convertedToUser Boolean @default(false)
}
